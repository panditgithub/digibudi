{% load static %}
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Landing Pages</title>
  

  <!-- link css -->
  <link rel="stylesheet" href="{% static 'static2/css/bootstrap.min.css' %}">
  <link rel="stylesheet" href="{% static 'static2/css/style.css' %}" >

  <!-- link font awsome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
</head>
<body>
  <!-- header start here -->
  {% include 'header_new.html' %}
  <!-- chat ui start here -->
  <section>
    <div class="chat_ui">
      <div class="container LandingContainer">
        <div class="chatUi_outer">
          <div class="chatUi_item">
            <div class="chatUi_left">
              <div class="top_hadding_topBar">
                <h6>Message</h6>
                  <div class="search_outer">
                    <input type="text" placeholder="Search" onkeyup="search(this)">
                    <img src="{% static 'static2/images/chatUi_sarch_ic.svg' %}" alt="search_icon">
                  </div>
                  {% if request.user.is_buyer %}

                  {% elif request.user.is_seller %}
                  <a href="{% url 'create_group' %}" class="add_new_btn">Add New Group</a>
                  {% endif %}
                
              </div>
              <div class="contact_list" id="searchresultdiv">
                {% for data in users %}
                <div class="contact_listItem">
                  <a class="search_name" href="{% url 'chat-room' username=data.first_name %}">
                  <div class="contact_listItem_left">
                    <div class="chat_item_outer1">
                      <img class="rightimg" src="{%static 'static2/images/default_client.png'%}" alt="thumb">
                      
                      {% comment %} <div class="chat_item_left1">
                        <span>b</span>
                        <div class="online_offline"></div>
                      </div> {% endcomment %}
                      <div class="chat_item_right1">
                        <h6 class="data_name"> {{data.username1}}</h6>
                      </div>
                    </div>
                  </div>
                </a>
                </div>
                {% endfor %}
              </div>
            </div>
            <!-- import right ui chat -->
            <div class="chatUi_right">
              <div class="chatUi_outerName">
                <div class="chatUi_right_item">
                  <div class="chatUi_left1">
                    <div class="rightSide_outer">
                      <img class="rightimg" src="{%static 'static2/images/default_client.png'%}" alt="thumb">
                      {% comment %} <div class="rightSide_Item_left name_C1">
                        <span>B</span>
                        <div class="online_offline"></div>
                      </div> {% endcomment %}
                      <div class="rightSide_Item_Right">
                        <h6>{{username.first_name}}</h6>
                      </div>
                    </div>
                  </div>
                  <div class="chatUi_right1">
                    <a class="btn btn-secondary dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown" aria-expanded="false"><img src="{% static  'static2/images/3manu_iconChat.svg' %}" alt="3Dots"></a>
                    <ul class="dropdown-menu profile_DropdownDiv" aria-labelledby="dropdownMenuLink">

                      <div class="dots_pop_outer">


                        <div class="dots_pop_outer1">
                          <div class="dots_popLeft">
                            <h6>Our projects</h6><span>Nesciunt nam fugiat sapien</span>
                            <p>Laboris labore voluptas dis, nascetur mollis mollit corporis earum quasi facilis...</p>
                          </div>
                          <div class="dots_popRight">
                            <span>$50 - $1,000</span>
                          </div>
                        </div>


                        <div class="dots_names">
                          <div class="dots_names_left">
                            <span>C</span>
                          </div>
                          <div class="dots_names_right">
                            <h6>Calwin Barry</h6>
                            <p>UI/UX Designer</p><span><img src="{% static 'static2/images/location_ic_dots.svg' %}" alt="location_icon" class="location_icon_pop">India - 8:30 pm Local Time</span>
                          </div>
                        </div>
                        <div class="dots_popSearch">
                          
                          <ul>
                            {% if request.user.is_buyer %}
                            <li>
                              <a href="#"><img src="{% static 'static2/images/3dot_searchIcon.svg'%}" alt="search_icon' %}" class="dots_searchIcon">Search Message <img src="{% static 'static2/images/message_inboxIcon.svg'%}" alt="arrow_leftIcon" class="arrow_inbox_icon"></a>
                            </li>
                            <li>
                              <a href="#"><img src="{% static 'static2/images/dots_popLink.svg'%}" alt="link" class="dots_searchIcon' %}">File & Links <img src="{% static 'static2/images/message_inboxIcon.svg' %}" alt="arrow_leftIcon" class="arrow_inbox_icon"></a>
                            </li>
                            {% elif request.user.is_seller %}
                            <li>
                              <a href="#"><img src="{% static 'static2/images/3dot_searchIcon.svg'%}" alt="search_icon' %}" class="dots_searchIcon">Search Message <img src="{% static 'static2/images/message_inboxIcon.svg'%}" alt="arrow_leftIcon" class="arrow_inbox_icon"></a>
                            </li>
                            <li>
                              <a href="#"><img src="{% static 'static2/images/dotsMan_icon.svg' %}" alt="popele" class="dots_searchIcon">People <img src="{% static 'static2/images/message_inboxIcon.svg' %}" alt="arrow_leftIcon" class="arrow_inbox_icon"></a>
                            </li>
                            <li>
                              <a href="#"><img src="{% static 'static2/images/dots_popLink.svg'%}" alt="link" class="dots_searchIcon' %}">File & Links <img src="{% static 'static2/images/message_inboxIcon.svg' %}" alt="arrow_leftIcon" class="arrow_inbox_icon"></a>
                            </li>
                            {% endif %}
                          </ul>

                        </div>
                      </div>

                    </ul>
                  </div>
                </div>
                <div class="our_Proposal">
                  <span>Our Proposal</span>
                  <div class="Search_input_Proposal">
                    <input type="search" placeholder="Search" data-search >
                    <img src="{%static 'static2/images/chatUi_sarch_ic.svg'%}" alt="search_icon">
                  </div>
                </div>
              </div>
              <div class="outer_chat_rightSide" id="chatLog">
                {% for message in messages %} 
                {% if message.sender == user %}
                <div class="outer_chat_Item">
                  <img class="rightimg" src="{%static 'static2/images/default_client.png'%}" alt="thumb">
                  {{message.user.username1}}
                  {% comment %} <div class="outer_chat_ItemLeft">
                    <span>B</span>
                    <div class="online_offline"></div>
                  </div> {% endcomment %}
                  <div class="outer_chat_ItemRight">
                    <div class="B_chat_outer">
                      <div class="B_chat_item1 B_chat_item2">
                        {% if message.file_type == 'image' %}
                        <div class="B_chat_item B_chat_space videoTag_outer">
                          <span style="height:auto;"><a href="{{message.message}}"   target="_blank"><img src="{{message.message}}" width="280px" alt="{{message}}"></a></span> {% elif message.file_type == 'text' %}
                          <div class="B_chat_item B_chat_space">
                            <span >{{message.message}}</span> 
                            {% elif message.file_type == 'video' %}
                            <div class="B_chat_item B_chat_space videoTag_outer">
                              <span style="height:auto;">
                                <video width="320" controls="">
                                  <span style="height:auto;">
                                    <span style="height:auto;"><source src="{{message.message}}" type="video/mp4">
                                    </span>
                                  </span>
                                </video>
                                </span> 
                              {% elif message.file_type == 'others' %}
                              <div class="B_chat_item B_chat_space">
                                <span><a href="{{message.message}}" target="_blank">{{message.message|cut:"http://127.0.0.1:8000/media/messagefiles/"}}</a></span> {% endif %}
                              </div>
                            </div><span class="Time_chat">{{message.timestamp|timesince}}</span>
                          </div>
                        </div>
                      </div>
                      {% else %}
                      <div class="outer_chat_ItemRight">
                        <div class="name_chat_ItemLeft">
                          <div class="chatUi_text1">
                            {% if message.file_type == 'image' %}
                            <div class="chatUi_text video_Outer" style="height: auto !important;padding: 0;background: none;border: unset;">
                              <span><a href="{{message.message}}" target="_blank"><img src="{{message.message}}" width="280px" alt="{{message"></a></span> {% elif message.file_type == 'text' %}
                              <div class="chatUi_text">
                                <span>{{message.message}}</span> {% elif message.file_type == 'video' %}
                                <div class="chatUi_text video_Outer" style="height: auto !important;padding: 0;background: none;border: unset;">
                                  <span><video width="320" height="240" controls=""><span><span><source src="{{message.message}}" type="video/mp4"></span></span></video></span> {% elif message.file_type == 'others' %}
                                  <div class="chatUi_text">
                                    <span><a href="{{message.message}}" target="_blank">{{message.message|cut:"http://127.0.0.1:8000/media/messagefiles/"}}</a></span> {% endif %}
                                  </div>
                                </div><span class="Time_chat">{{message.timestamp|timesince}}</span>
                              </div>
                              <img class="rightimg" src="{%static 'static2/images/default_user.png'%}" alt="thumb">
                              {% comment %} <div class="name_chat_ItemRight">
                                <span>C</span>
                                <div class="online_offline"></div>
                              </div> {% endcomment %}
                            </div>{% endif %} {% endfor %}
                          </div>
                          <div class="inputFlied_Right">
                            {% comment %} <div class="user_name_ChatUI">
                              <span>C</span>
                              <div class="online_offline"></div>
                            </div> {% endcomment %}
                            <div class="inputFlied_submit">
                              <input type="text" class="form-control" id="chatMessageInput" placeholder="type message here" aria-describedby="emailHelp">
                              <div class="mic_icon">
                                <img src="{% static 'static2/images/mic_iconInput.svg' %}" alt="mic_icon" >
                              </div>
                              <div class="button-wrapper">
                                <span class="label">
                                  <img src="{% static 'static2/images/gallary_icon_input.svg' %}" alt="gallary_icon ">
                                </span><input type="file" name="upload" id="fileupload" class="upload-box" placeholder="Upload File" aria-label="Upload File">
                              </div>
                              <button type="submit" class="btn btn-primary"><img src="{% static 'static2/images/send_icon_input.svg' %}" id="chat-message-submit" alt="send_icon"></button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- chat ui close here -->

 
  {{user|json_script:"json-username"}}
  {{request.user.id|json_script:"json-message-username"}}

  
  <script src="{% static 'static2/js/bootstrap.bundle.min.js' %}"></script>

  <script>
    function search(e){
      let data=document.getElementsByClassName('data_name');
     //console.log(e)
      var term =e.value;
      var regex= new RegExp(term,'gi')
          for (let i = 0; i < data.length; i++) {
            if(data[i].innerHTML.match(regex)){
              console.log(data[i].closest('.contact_listItem').style.display='block')
            }else{
              console.log(data[i].closest('.contact_listItem').style.display='none')
            }
            
            
            let thediv=$('#searchresultdiv');
          }
    }
  </script>

  <script>

    const reciever_id = JSON.parse(document.getElementById('json-username').textContent);
    const send_id = JSON.parse(document.getElementById('json-message-username').textContent);
    let chatLog = document.querySelector("#chatLog");
    let chatMessageInput = document.querySelector("#chatMessageInput");
    let chatMessageSend = document.querySelector("#chat-message-submit");
    console.log(send_id, reciever_id)
    let socket = null;
    chatMessageInput.focus();
    // submit if the user presses the enter key
    chatMessageInput.onkeyup = function(e) {
    if (e.keyCode === 13) {  // enter key
    chatMessageSend.click();
    }
    };
   
      
    try{
        socket = new WebSocket('ws://' + window.location.host + '/ws/' + reciever_id + '/');
    
    
        socket.onopen = function(e){
            console.log("CONNECTION ESTABLISHED", 'ws://'+window.location.host+'/ws/'+reciever_id+'/');
        }
    
        socket.onclose = function(e){
            console.log("CONNECTION LOST", 'ws://'+window.location.host+'/ws/'+reciever_id+'/');
        }
    
        socket.onerror = function(e){
            console.log("ERROR OCCURED", 'ws://'+window.location.host+'/ws/'+reciever_id+'/');
        }
    }
    catch{
        socket = new WebSocket('wss://' + window.location.host + '/wss/' + reciever_id + '/');
    
    
        socket.onopen = function(e){
            console.log("CONNECTION ESTABLISHED", 'wss://'+window.location.host+'/wss/'+reciever_id+'/');
        }
    
        socket.onclose = function(e){
            console.log("CONNECTION LOST", 'wss://'+window.location.host+'/wss/'+reciever_id+'/');
        }
    
        socket.onerror = function(e){
            console.log("ERROR OCCURED", 'wss://'+window.location.host+'/wss/'+reciever_id+'/');
    }
    }
    chatMessageSend.onclick = function() {
      if (chatMessageInput.value.length === 0) return;
      socket.send(JSON.stringify({
      "message": chatMessageInput.value,
      'username':reciever_id,
      'file_type': 'text'
      }));
      chatMessageInput.value = "";
      $(".outer_chat_rightSide").stop().animate({ scrollTop: $(".outer_chat_rightSide")[0].scrollHeight}, 1000);
      };
    
    socket.onmessage = function(e){
        console.log(e.data.message)
        const data = JSON.parse(e.data);
        var today= new Date();
        time_since = timeSince(today);
        if (data.file_type == 'image'){
          if(data.user_id == reciever_id ){
            var mymsg = `<div class="B_chat_item B_chat_space videoTag_outer"> <span><a href="${data.message}" target="_blank"><image src=" ${data.message}" width="280px"></a><span></div>`
            }
          else{
            var mymsg = `<div class="chatUi_text" style="height: auto !important;padding: 0;background: none;border: unset;"> <span><a href="${data.message}" target="_blank"><image src=" ${data.message}" width="280px"></a><span></div>`
            }

        }
        else if (data.file_type == 'text'){
          if(data.user_id == reciever_id ){
            var mymsg = `<div class="B_chat_item B_chat_space"> <span><p>${data.message}</p><span></div>`
            }
          else{
            var mymsg = `<div class="chatUi_text"> <span><p>${data.message}</p><span></div>`
          }
        }
        else if (data.file_type == 'video'){
          if(data.user_id == reciever_id ){
            var mymsg = `<div class="B_chat_item B_chat_space videoTag_outer"> <span><video width="320" height="240" controls>
            <source src="${data.message}" type="video/mp4">
           </video><span></div>`
          }
          else{
            var mymsg = `<div class="chatUi_text" style="height: auto !important;padding: 0;background: none;border: unset;"> <span><video width="320" height="240" controls>
              <source src="${data.message}" type="video/mp4">
            </video><span></div>`
          }
        }
        else if (data.file_type == 'others'){
          if(data.user_id == reciever_id ){
            var mymsg =`<div class="B_chat_item B_chat_space"> <span><a href="${data.message}" target="_blank">${data.message.slice(41,)}</a><span></div>`}
          else{
            var mymsg =`<div class="chatUi_text"> <span><a href="${data.message}" target="_blank">${data.message.slice(41,)}</a><span></div>`
          }
        }
        else{
            var mymsg = `${data.message}`
        }
        if(data.user_id == reciever_id){
          document.querySelector('.outer_chat_rightSide').innerHTML += 
                                          `<div class="outer_chat_Item">
                                            <img class="rightimg" src="{%static 'static2/images/default_client.png'%}" alt="thumb">
                                            
                                            {% comment %} <div class="outer_chat_ItemLeft">
                                              <span>B</span>
                                              <div class="online_offline"></div>
                                            </div> {% endcomment %}
                                            <div class="outer_chat_ItemRight">
                                              <div class="B_chat_outer">
                                                <div class="B_chat_item1 B_chat_item2">
                                                  `+ mymsg +`
                                                </div>
                                                <span class="Time_chat">${time_since}</span>
                                              </div>
                                            </div>
                                          </div>`
                                                              
      }else{
          document.querySelector('.outer_chat_rightSide').innerHTML += 
                                            `<div class="outer_chat_ItemRight">
                                              <div class="name_chat_ItemLeft">
                                                <div class="chatUi_text1">
                                                  `+ mymsg +`
                                                </div>
                                                <span class="Time_chat">${time_since}</span>
                                              </div>
                                              <div class="name_chat_ItemRight">
                                                <span>C</span>
                                                <div class="online_offline"></div>
                                              </div>
                                            </div>`
      $(".outer_chat_rightSide").stop().animate({ scrollTop: $(".outer_chat_rightSide")[0].scrollHeight}, 1000);
      }
    
    
        
    }
    
  
    
    
    
    $("#chat-message-submit").click(function(){
  
      var form_data = new FormData()
      
      var ins = document.getElementById("fileupload").files.length;
      
      for(var x = 0; x<ins;x++){
        form_data.append("files[]",document.getElementById("fileupload").files[x]);
        
      }
      
      csrf_token = $("input[name=csrfmiddlewaretoken").val();
    
        form_data.append('csrfmiddlewaretoken',csrf_token);
        
    
        $.ajax({
            url:"{% url 'imagesend1' %}",
            cache:false,
            dataType:"json",
            contentType:false,
            processData:false,
            type:"POST",
            data: form_data,
            success: function(response){
                console.log(response.url)
                let hostname = window.location.origin
                console.log(hostname+response.url)
    
                let img_url = hostname+response.url
                console.log(response.msgtype)
    
    
                if(response.msgtype == 'image'){
                    var msgtype = 'image';
                    console.log(msgtype)
                    
                }
                else if(response.msgtype == 'video'){
                    var msgtype = 'video';
                    
                }
                else if(response.msgtype == 'others'){
                    var msgtype = 'others';   
                }
                socket.send(JSON.stringify({
                    'message':img_url,
                    'username':reciever_id,
                    'file_type':msgtype
                }))
                document.getElementById('fileupload').value=''
    
            }
        })
    })
    
    
    $("#chat-message-submit").click(function() {
      $(".outer_chat_rightSide").stop().animate({ scrollTop: $(".outer_chat_rightSide")[0].scrollHeight}, 1000);
    });
    
    $("#btnn").click(function() {
      $(".outer_chat_rightSide").stop().animate({ scrollTop: $(".outer_chat_rightSide")[0].scrollHeight}, 1000);
    });
    
    
    
    
    
    function myFunction() {
        var input, filter, ul, li, a, i, txtValue;
        input = document.getElementById("myInput");
        filter = input.value.toUpperCase();
        ul = document.getElementById("myUL");
        li = ul.getElementsByTagName("li");
        for (i = 0; i < li.length; i++) {
            a = li[i].getElementsByTagName("a")[0];
            txtValue = a.textmessage || a.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                li[i].style.display = "";
            } else {
                li[i].style.display = "none";
            }
        }
      }
      
    
    function sendimg(url){
      alert(url);
    }
    function timeSince(date) {
    
    var seconds = Math.floor((new Date() - date) / 1000);
    
    var interval = seconds / 31536000;
    
    if (interval > 1) {
        return Math.floor(interval) + " years";
    }
    interval = seconds / 2592000;
    if (interval > 1) {
        return Math.floor(interval) + " months";
    }
    interval = seconds / 86400;
    if (interval > 1) {
        return Math.floor(interval) + " days";
    }
    interval = seconds / 3600;
    if (interval > 1) {
        return Math.floor(interval) + " hours";
    }
    interval = seconds / 60;
    if (interval > 1) {
        return Math.floor(interval) + " minutes";
    }
    return Math.floor(seconds) + " seconds";
    }
     
    $("#btnn").click(function(){
              var form_data = new FormData()
              var ins = document.getElementById('fileupload').files.length;
              
              if (ins == 0){
                $("#msg").html('<div class="alert alert-danger" role="alert">Select at least one file</div>');
                return;
              }
    
              for(var x = 0; x < ins; x++){
                form_data.append('files[]',document.getElementById('fileupload').files[x]);
              }
    
              csrf_token = $("input[name=csrfmiddlewaretoken").val();
              form_data.append('csrfmiddlewaretoken',csrf_token);
              console.log(form_data);
    
              $.ajax({
                url:"",
                cache : false,
                dataType: 'json',
                messageType : false,
                processData : false,
                type : 'POST',
                data : form_data,
    
                success:function(response){
                  //$("#msg").html(response.msg);
                  console.log(response.url)
                  let hostname = window.location.origin;
                  console.log(hostname + response.url)
                  let imgurl= hostname + response.url
                  alert(imgurl)
                  if (response.msgtype == 'image'){
                    var msgtype = 'image';
                  }
                  else if (response.msgtype == 'video')
                  {
                    var msgtype = 'video';
                  }
                  else if (response.msgtype == 'others')
                  {
                    var msgtype = 'others';
                  }
                  
                  socket.send(JSON.stringify({
                    'message':imgurl,
                    'username':reciever_id,
                    'file_type':msgtype
                }));
             
    
                },
                error: function(response){
                  $("#msg").html(response.message);
    
                }
              })
              document.getElementById("fileupload").value = "";
    
    
              
    
    
            })
            
        
</script>

<script>
  $(document).ready(function(){
    $(".Search_input_Proposal").hide()
    $(".dots_searchIcon").click(function(){
      $(".Search_input_Proposal").show()

    })
  })
</script>

<script>
  $('[data-search]').on('keyup', function() {
    var searchVal = $(this).val();
    var filterItems = $('[data-filter-item]');
    if ( searchVal != '' ) {
      filterItems.addClass('hidden');
      $('[data-filter-item][data-filter-name*="' + searchVal.toLowerCase() + '"]').removeClass('hidden');
    } else {
      filterItems.removeClass('hidden');
    }
  })
</script>

</body>
</html>